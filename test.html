<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Falling Tiles 18x18</title>
<style>
html, body { margin:0; padding:0; height:100%; width:100%; background:#111; color:white; font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; overflow:hidden; }
#top-bar { display:flex; justify-content:center; width:100%; margin-top:10px; align-items:center; font-family: monospace; font-size: 1.2em; }
#game-container { flex:1; display:flex; justify-content:center; align-items:center; width:100%; }
#game { display:grid; grid-template-columns: repeat(18, 1fr); grid-template-rows: repeat(18, 1fr); gap:2px; width:90vmin; height:90vmin; }
.tile { background:#444; width:100%; height:100%; transition: background 0.3s, transform 0.4s, opacity 0.4s; }

/* Safe tile styling */
.safe-zone { background: #222 !important; border: 1px solid #444; }

.player { background:#0f0 !important; z-index: 2; }
.warning { background:red !important; }
.falling { transform:translateY(50px); opacity:0; }

#death-screen { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; justify-content:center; align-items:center; z-index:5; }
#death-screen h2, #death-screen p { margin:5px; text-align:center; }
#play-again { margin-top:10px; padding:6px 12px; cursor:pointer; border:none; border-radius:5px; }

#music-btn {
    margin-left: 20px;
    background: #444;
    color: white;
    border: 1px solid #777;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 14px;
    border-radius: 4px;
}
.credits { font-size: 0.6em; color: #888; margin-left: 10px; }
</style>
</head>
<body>

<div id="top-bar">
    <div>Score: <span id="score-val">0</span></div>
    <div class="credits">Song: John Bartmann</div>
    <button id="music-btn" onclick="toggleMusic()">ðŸŽµ Music: OFF</button>
</div>

<audio id="bgm" loop>
    <source src="racetodeath.mp3?v=REAL" type="audio/mpeg">
</audio>
    
<div id="game-container">
    <div id="game"></div>
</div>

<div id="death-screen">
    <h2 id="death-title">You Died!</h2>
    <p id="death-score"></p>
    <button id="play-again">Play Again</button>
</div>

<script>
const SIZE = 18;
const WARNING_TIME = 1000;
const DROP_INTERVAL = 800;

const game = document.getElementById("game");
const deathScreen = document.getElementById("death-screen");
const deathTitle = document.getElementById("death-title");
const deathScore = document.getElementById("death-score");
const scoreSpan = document.getElementById("score-val");

let grid = [];
let player = { x: Math.floor(SIZE/2), y: Math.floor(SIZE/2) };
let dropLoop;
let score = 0;
let paused = false;

// --- MUSIC LOGIC ---
let isMusicOn = false;
const bgm = document.getElementById('bgm');
bgm.volume = 0.5; 

function toggleMusic() {
    const btn = document.getElementById('music-btn');
    if (isMusicOn) {
        bgm.pause();
        btn.innerText = "ðŸŽµ Music: OFF";
        btn.style.background = "#444";
        isMusicOn = false;
    } else {
        bgm.play().catch(e => console.log("Error playing:", e));
        btn.innerText = "ðŸŽµ Music: ON";
        btn.style.background = "#00b894"; 
        isMusicOn = true;
    }
}

function createGrid() {
    game.innerHTML = "";
    grid = [];
    for(let y=0;y<SIZE;y++){
        let row=[];
        for(let x=0;x<SIZE;x++){
            const tile=document.createElement("div");
            tile.classList.add("tile");
            // Highlight the safe spawn tile
            if(x === 9 && y === 9) tile.classList.add("safe-zone");
            game.appendChild(tile);
            row.push({element:tile, exists:true, dropping:false});
        }
        grid.push(row);
    }
}

function drawPlayer() {
    document.querySelectorAll(".tile").forEach(t=>t.classList.remove("player"));
    if(grid[player.y] && grid[player.y][player.x] && grid[player.y][player.x].exists){
        grid[player.y][player.x].element.classList.add("player");
    } else {
        endGame(false);
    }
}

function getRandomExistingTile(){
    let existing=[];
    for(let y=0;y<SIZE;y++){
        for(let x=0;x<SIZE;x++){
            // RULE: Never pick the center tile (9,9)
            if (x === 9 && y === 9) continue;
            
            if(grid[y][x].exists && !grid[y][x].dropping) existing.push({x,y});
        }
    }
    return existing.length === 0 ? null : existing[Math.floor(Math.random()*existing.length)];
}

function triggerRandomDrop(){
    if(paused) return;
    
    const t = getRandomExistingTile();
    if(!t) return;
    
    const tile = grid[t.y][t.x];
    tile.dropping=true;
    tile.element.classList.add("warning");
    
    setTimeout(()=>{
        if (paused) return;
        tile.exists=false;
        tile.element.classList.remove("warning");
        tile.element.classList.add("falling");
        score++;
        scoreSpan.textContent = score; 
        
        if(player.x===t.x && player.y===t.y) {
            endGame(false);
        } else {
            checkWinCondition();
        }
        tile.dropping = false;
    }, WARNING_TIME);
}

function checkWinCondition() {
    // Count how many tiles still exist
    let remaining = 0;
    for(let y=0; y<SIZE; y++) {
        for(let x=0; x<SIZE; x++) {
            if(grid[y][x].exists) remaining++;
        }
    }
    // If only the safe tile remains, you win!
    if (remaining === 1) {
        endGame(true);
    }
}

function move(dx,dy){
    if(paused) return;
    player.x+=dx; player.y+=dy;
    if(player.x<0||player.x>=SIZE||player.y<0||player.y>=SIZE||!grid[player.y][player.x].exists){
        endGame(false);
        return;
    }
    drawPlayer();
}

function endGame(isWin){
    paused=true;
    clearInterval(dropLoop);
    deathTitle.textContent = isWin ? "YOU WIN!" : "You Died!";
    deathTitle.style.color = isWin ? "#f1c40f" : "red";
    deathScore.textContent = "Final Score: " + score;
    deathScreen.style.display = "flex";
}

function startGameLoop(){
    paused=false;
    score=0;
    scoreSpan.textContent = score;
    player={ x: 9, y: 9 }; // Center spawn
    createGrid();
    drawPlayer();
    dropLoop = setInterval(triggerRandomDrop, DROP_INTERVAL);
}

document.addEventListener("keydown", e=>{
    switch(e.key){
        case "ArrowUp": move(0,-1); break;
        case "ArrowDown": move(0,1); break;
        case "ArrowLeft": move(-1,0); break;
        case "ArrowRight": move(1,0); break;
    }
});

document.getElementById("play-again").addEventListener("click",()=>{
    deathScreen.style.display="none";
    startGameLoop();
});

startGameLoop();
</script>

</body>
</html>
